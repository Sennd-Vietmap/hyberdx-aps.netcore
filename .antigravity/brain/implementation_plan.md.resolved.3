# NuGet Package Plan: ClickHouse.ClickStack.AspNetCore

This plan outlines the creation of a reusable NuGet package to simplify the integration of ClickStack (OpenTelemetry + ClickHouse) into ASP.NET Core applications.

## User Review Required

> [!IMPORTANT]
> The primary goal is to move the logic from the current `ClickStack.Api` project into a dedicated library. This will allow other projects to use the same observability patterns easily.

## Proposed Changes

### New Class Library: `ClickHouse.ClickStack.AspNetCore`

#### [NEW] [ClickStackOptions.cs](file:///d:/study/google-antigravity/clickstack-aspnet/ClickHouse.ClickStack.AspNetCore/ClickStackOptions.cs)
Define a configuration class to hold the endpoint, API key, and other settings.
```csharp
public class ClickStackOptions
{
    public string ServiceName { get; set; } = "unknown-service";
    public string ServiceVersion { get; set; } = "1.0.0";
    public string OtelEndpoint { get; set; } = "http://localhost:4317";
    public string? ApiKey { get; set; }
    public bool EnableAccountTracking { get; set; } = true;
    public string AccountHeaderName { get; set; } = "X-Account-Id";
}
```

#### [NEW] [ServiceCollectionExtensions.cs](file:///d:/study/google-antigravity/clickstack-aspnet/ClickHouse.ClickStack.AspNetCore/ServiceCollectionExtensions.cs)
Provide extension methods for `IServiceCollection` or `IHostApplicationBuilder`.
- [AddClickStack()](file:///d:/study/google-antigravity/clickstack-aspnet/ClickStack.Api/Extensions/ClickStackExtensions.cs#10-77): Configures OTel logging, metrics, and tracing.

#### [NEW] [ApplicationBuilderExtensions.cs](file:///d:/study/google-antigravity/clickstack-aspnet/ClickHouse.ClickStack.AspNetCore/ApplicationBuilderExtensions.cs)
Provide extension methods for `IApplicationBuilder` to register the middleware.
- `UseClickStack()`: Adds the Account ID tracking middleware.

### Refactoring `ClickStack.Api`

#### [MODIFY] [ClickStack.Api.csproj](file:///d:/study/google-antigravity/clickstack-aspnet/ClickStack.Api/ClickStack.Api.csproj)
- Add a reference to the new library.
- Remove redundant OpenTelemetry packages if they are now transitive dependencies.

#### [MODIFY] [Program.cs](file:///d:/study/google-antigravity/clickstack-aspnet/ClickStack.Api/Program.cs)
- Replace local middleware and extensions with library calls.
```csharp
builder.AddClickStack(options => {
    options.ServiceName = "clickstack-demo-api";
});
// ...
app.UseClickStack();
```

---

## Verification Plan

### Automated Tests
- Create a unit test project `ClickHouse.ClickStack.AspNetCore.Tests`.
- Verify that [AddClickStack](file:///d:/study/google-antigravity/clickstack-aspnet/ClickStack.Api/Extensions/ClickStackExtensions.cs#10-77) correctly registers OTel services.
- Verify that the middleware correctly sets tags.

### Manual Verification
1. Build the library.
2. Reference it from the demo API.
3. Run the stack and verify that telemetry is still arriving at `http://localhost:8080`.
